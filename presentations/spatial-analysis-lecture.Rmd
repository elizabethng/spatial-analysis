---
title: "Spatial Analysis"
subtitle: "FSH 507 Fall 2019"
author: "Elizabeth Ng"
date: " `r Sys.Date()`"
output:
  ioslides_presentation: default
  powerpoint_presentation: default
  html_document: default
  slidy_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library("tidyverse")
library("sf")
```

## Overview
1. Motivation--reproducible workflows
2. Brief intro to generic spatial data (crs, projections, raster vs vector data)
3. Brief intro to spatial capabilities in R
4. Intro to the sf package
5. Reading and writing spatial data with sf (shapefiles, lat/lon, other data)
6. Geometric operations with sf
7. Making maps with sf and ggplot2

## Motivation

* Who uses spatial data?
* Can you relate to this workflow?
  - An example going back and forth between ArcGIS and `R`
  - Frustrating!
  - Wouldn't it be great if we could do this all in `R`
* Reproducible workflows!


# Overview of spatial analysis

## Why do we need to deal with spatial data?
* Interesting spatial questions
* The Earth is round-ish/spherioid
* Maps and screens are flat, so we only see projected data
* Projected distances, areas, shapes, and directions are often distorted
* Coordinates are made up of 2-3 numbers that only have meaning when used together
* [Reference](https://edzer.github.io/rstudio_conf/#6)

## (side note) Reference systems (?)
* geodesic/geographic coordinates need
  - an order (lat/long vs long/lat)
  - a unit (rad, arc_degree)
  - a datum (aka reference ellipsoid)
    * how are we describing the shape of the Earth?
    * "best" approximation depends on region and scale
      - what origin is used?
      - tectonic plates move over time
      - e.g., WGS84, is an approximate model of Earth at sea level updated in 2004
* (cartesian/projected coordinates)[https://www.axismaps.com/guide/general/map-projections/] need
  - a unit (km, m)
  - relationship to a datum/geodesic coordinates
  - how to display a three dimensional object in two dimensions
  - accurately display one of:
    * area (Mercator)
    * form (Azimuthal Equidistant)
    * distance (Equirectangular)
  - choice depends on what you're conveying, shape of the region
  - e.g., use Tranverse Mercator for mapping long N-S region like Chile
* two separate issues: how do we model Earth (datum) and how do we display it on a flat surface (projection)


## Models of a round-ish Earth
* There are different models of the Earth
* Meaning of coordinates (lon/lat) depend on the geodetic datum
* "_Geodetic datum_ is a coordinate reference system and a set of reference points used to locate places on Earth"[Wikipedia](https://en.m.wikipedia.org/wiki/Geodetic_datum)
* "a datum is unlikely important when mapping continents, but it is when when drones try to deliver pizza" -[Edzer Pebesma]https://edzer.github.io/rstudio_conf/#6)
* Depend on the scale (big or small matter more? where you are matters?)
* On one hand, small areas are more easily modeled as a flat surface
* But get your model wrong from continent to drone delivery matters
* Model is described in a coordinate reference system (CRS)
* Two types
  - geographic CRS (lon/lat) gives distance from the origin in degrees
  - projected CRS (easting/northing) gives distance from the origin in km
- [ ] Datum??

## Data models
- *vector data model* uses points, lines, and polygons
- *raster data model* divides surface into cells of constant size
- today we'll be dealing with vector data using the `sf` package

## Representation of spatial data
* Vector
  - think vector graphics (pdf)
  - an equation for the object
  - counts, lines, polygons
  - typically think of x,y coordinates, but can have other dimensions
* Raster
  - think images with pixels (jpeg)
  - divides area into small cells
  - each cell gets a value
  - aerial imagery, remote sensing, sattelite data

## Representation of non-spatial data
* Attributes
  - Often other information we want to capture
  - How many counts at a point?
  - Length of a transect
  - Land-cover type of a polygon

## Things we want to do with spatial software...
1. Read/write spatial data
2. Represent geographic and attribute data
3. Transform between different models of Earth
4. Geographic operations

## Geographic/Spatial operations
Relate to configuration in space
```{r}
# Insert an image here, or make an example of a buffered river
# with points, using sf()
```


## Things we want to do with spatial software...
1. Read/write spatial data
2. Represent geographic and attribute data
3. Transform between different models of Earth
4. Geographic operations
5. Make maps!


# Brief background on spatial analysis in R

## R packages for spatial analysis
- Some tools early on
- `rgdal` released in 2003--import from more geographic data formats
- `sp` released in 2005--creates spatial objects with classes and generic methods for points, lines, polygons, grids, and attribute data
-  But still lacked ability to do geometric operations
- `raster` released in 2010--support for raster operations and more

## R packages linking to GIS software
- `GRASS`, `spgrass6`, and `rgrass7`
- `RSAGA`, `RPyGeo`, and `RQGIS`

## Visualization
- `ggplot2`
- `ggmap`
- `rasterVis`
- `tmap`
- `leaflet`
- `mapview`

## Brief comparison of `sp` vs `sf`
* `sp` older and more stable
* `sf` gaining traction, lots of development, integrates well with `tidyverse`
  - Based on [simple features ISO standards](https://en.wikipedia.org/wiki/Simple_Features) that are not R specific
  - can replace `sp`, `rdgal` for read/write, and `rgeos` for geometric operations
* [ ] Put diagram here? Showing how sf links to GDAL, GEOS, Proj.4 etc.


## Resources
There is an overwhelming about of information available

* [Simple Features package](https://r-spatial.github.io/sf/index.html)
  - Vignettes, blogs, presentations
  - [Cheatsheet](https://github.com/rstudio/cheatsheets/blob/master/sf.pdf)
  - [issue tracker](https://github.com/r-spatial/sf/issues/)
* [r-spatial](https://www.r-spatial.org/about/) Edzer Pebesma's blog
* [Spatial Data Science](https://keen-swartz-3146c4.netlify.com/)
* [Geocomputation with R](https://geocompr.robinlovelace.net/)
  - excellent in-depth treatment
  - includes theory, examples, and covers rasters
* Lots of others
* Word of caution--`sf` has undergone rapid development in past ~5 years
* Check dates on blogs, StackExchange, GitHub issues


# `sf` Package

## Simple features
* _feature_ "abstraction of real world phenomena"
* _simple feature_ "feature with all geometric attributes described by piecewise straight lines or planar interpolation between sets of points"
* Represents geometry using *points*, *lines*, *polygons*, or collections of those features
* ISO standard supported by lots of software

## Basic structure
* `sf` objects are extended `data.frame`s or `tibble`s
  - attribute data stored as `tibble`
  - geometry stored as a list column
  - can have multiple types of geometry in one object
* class is `sfc` with bounding box `bbox` and `CRS` attributes

```{r}
# show an example
# either code or use images of examples
# ??? What happens if you `unnest` the geometry column?

# Highlight parts
# 1. list column (aka sfc)
# 2. feature geometry (sfg)
# 3. feature (row)
```

## `sf` and `tidyverse`
* `sf` functions begin with `st_`
* `sf` methods for `filter`, `arrange`, `distinct`, `group_by`, `ungroup`, `mutate`,

## Manipulating objects
* manipulating geometry
  - summary
  - plot
  - other default methods
* manipulating attribute data
  - works well with `dplyr`
  - summarize
  - filter etc.

```{r}
# Example manipulations? Or wait until after reading and writing?
```


# Reading and Writing Data

## Reading shapefiles
* super straightforward...
```{r}
fileloc <- system.file("shape/nc.shp", package = "sf")
nc <- read_sf(fileloc)
print(nc, n = 3)
plot(nc, max.plot = 4)
```
We can see that projection information is stored with the shapefile
```{r}
st_crs(nc)
```

## Converting lat/lon data to spatial object
[see this link for info](https://edzer.github.io/UseR2017/)
* `st_transform` transforms or converts coordinates to new reference system
```{r}
(a1 <- st_area(nc[1,]))) # area, using geosphere::areaPolygon
(a2 <- st_area(st_transform(nc[1, ], 32119))) # NC state plane, m
(a3 <- st_area(st_transform(nc[1,], 2264))))  # NC state plane, US foot

units::set_units(a1, km^2)
units::set_units(a2, km^2)
units::set_units(a3, km^2)
```

* need to set crs
https://georepository.com/crs_32619/WGS-84-UTM-zone-19N.html
https://spatialreference.org/ref/epsg/2033/

## Reference systems
* handle coordinate systems, convert coordinates (do projections), and do datum transformations
* `crs` object contains this information
* Proj.4 string contains this info
```{r}
st_crs("+proj=longlat +datum=WGS84") # Proj.4 string"
st_crs(3857)                         # ESPG code
st_crs(3857)$units                   # check units
st_crs(NA)                           # unknown (assumed planar/Cartesian)
```

## Other data sources
* Convert other `Spatial*` objects using `st_as_sf`
* Download online (US Map...others?)
* So much in packages
* `naturalearth`
* access to google maps??

## Writing data
* shapefiles
* database connections

## Exercises
1. Download a shapefile at XYZ, read in R and summarize
2. Upload lat/lon data in data file. Pick a CRS, save it as a shapefile


# Geometric operations

## Geometric operations
Single
* logical predicates: (e.g., `is_valid`, `is_simple`)
* quantities: (`length`, `area`)
* dimensions: 0 = points, 1 = linear, 2 = surface
* derived geometries: `buffer`, `centroid`, `convex_hull` etc.

Pairs or sets
* predicates: `intersects`, `within`, `contains` etc.
* quantities: `distance`
* new geometries: `intersection`, `difference`, `union` etc.

CHECK: what does predicate mean?

## Give some examples...

## Exercises
1. How many points are within 10 km of this river?
2. Create a 1 km x 1 km sampling grid and randomly select 10 survey locations.


# Making maps with `sf` and `ggplot2`

## Basics
* interfaces with `ggplot2` using `geom_sf`

## Using multiple types of data

## Faceting with a basemap

## Issues with legends

## Adding compass rose and scale



# What about other types of data?

## `stars`
* support for raster and vector data cubes (arrays)
* support for long time series on vector data
* deal with data sets larger than local memory
* finished 2018 (??)
